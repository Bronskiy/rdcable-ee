/*!
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		EllisLab Dev Team
 * @copyright	Copyright (c) 2003 - 2016, EllisLab, Inc.
 * @license		https://expressionengine.com/license
 * @link		https://ellislab.com
 * @since		Version 2.0
 * @filesource
 */
!function(e){"use strict";EE.namespace=function(e){var t=e.split("."),o=EE;"EE"===t[0]&&(t=t.slice(1));for(var a=0,n=t.length;a<n;a+=1)"undefined"==typeof o[t[a]]&&(o[t[a]]={}),o=o[t[a]];return o},EE.namespace("EE.cp"),e.ajaxPrefilter(function(t,o,a){var n=EE.CSRF_TOKEN,i=t.type.toUpperCase();_.has(t,"error")||a.fail(function(e,t,o){_.defer(function(){throw o})}),"POST"==i&&t.crossDomain===!1&&a.setRequestHeader("X-CSRF-TOKEN",n);var s={eexid:function(e){e&&EE.cp.setCsrfToken(e)},"csrf-token":function(e){e&&EE.cp.setCsrfToken(e)},"ee-redirect":function(e){window.location=EE.BASE+"&"+e.replace("//","/")},"ee-broadcast":function(t){EE.cp.broadcastEvents[t](),e(window).trigger("broadcast",t)}},r=e.merge(s,o.eeResponseHeaders||{});a.complete(function(e){t.crossDomain===!1&&_.each(r,function(t,o){var a=e.getResponseHeader("X-"+o);a&&t(a)})})}),EE.grid_cache=[],window.Grid={bind:function(){EE.grid_cache.push(arguments)}},e(document).ready(function(){!1 in document.createElement("input")&&EE.insert_placeholders(),EE.cp.cleanUrls(),EE.cp.bindCpMessageClose(),EE.cp.bindSortableFolderLists(),EE.cp.addLastToChecklists(),EE.cp.bindPostLinks()}),EE.cp.bindPostLinks=function(){e("body").on("click","a[data-post-url]",function(t){t.preventDefault();var o=e("<form/>",{action:e(this).data("postUrl"),method:"post"});o.append(e("<input/>",{name:"csrf_token",value:EE.CSRF_TOKEN})),o.appendTo("body").submit()})},EE.cp.addLastToChecklists=function(){e("ul.nested-list li").removeClass("last"),e("ul.nested-list").each(function(){e("li:last-child",this).not("ul.toolbar li").last().addClass("last")})},EE.cp.bindCpMessageClose=function(){e("body").on("click","div.alert a.close",function(t){t.preventDefault(),e(this).parent().hide()})},EE.cp.bindSortableFolderLists=function(){e(".sidebar .folder-list.reorderable").sortable({axis:"y",containment:"parent",handle:"a",cancel:"ul.toolbar",items:"> li",sort:EE.sortable_sort_helper,stop:function(t,o){var a,n=e(this).data("name");if(void 0!==EE.cp.folderList.eventHandlers[n])for(a=0;a<EE.cp.folderList.eventHandlers[n].length;a++)EE.cp.folderList.eventHandlers[n][a](e(this))}})},EE.cp.folderList={eventHandlers:[],onSort:function(e,t){void 0==this.eventHandlers[e]&&(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t)}},EE.cp.setCsrfToken=function(t,o){e('input[name="XID"]').val(t),e('input[name="csrf_token"]').val(t),EE.XID=t,EE.CSRF_TOKEN=t,o||e(window).trigger("broadcast.setCsrfToken",t)},e(window).bind("broadcast.setCsrfToken",function(e,t){EE.cp.setCsrfToken(t,!0)});var t=/[&?](S=[A-Za-z0-9]+)/;EE.cp.setBasePath=function(o,a){var o=o.replace(/&amp;/g,"&"),n=o.match(t)||["",""],i=EE.BASE.match(t)||["",""],s=function(e,t){if(t)return t.replace(i[1],n[1])};e("a").attr("href",s),e("form").attr("action",s),"function"==typeof window.history.pushState&&window.history.replaceState(null,document.title,window.location.href.replace(i[1],n[1])),EE.BASE=o,a||e(window).trigger("broadcast.setBasePath",o)},e(window).bind("broadcast.setBasePath",function(e,t){EE.cp.setBasePath(t,!0)}),e(window).bind("broadcast.setRememberMe",function(e,t){EE.hasRememberMe=t}),EE.cp.refreshSessionData=function(t,o){o&&EE.cp.setBasePath(o),e.getJSON(EE.BASE+"&C=login&M=refresh_csrf_token",function(e){EE.cp.setBasePath(e.base)})};var o=/(.*?)[?](.*?&)?(D=cp(?:&C=[^&]+(?:&M=[^&]+)?)?)(?:&(.+))?$/,a=/&?[DCM]=/g,n=/^&+/,i=/&+$/,s=/(^|&)S=0(&|$)/;EE.cp.cleanUrl=function(e,t){t=t||e,t=t||"",t=t.toString().replace(/^(\S*?)S=(\S+?)&(\S*?)$/g,"$1$3&S=$2");var r=o.exec(t);if(r){var c=r[3].replace(a,"/"),l=r[2]||"",d=r[4]||"",u=r[1]+"?"+c,E=d.replace(s,"")+"&"+l.replace(s,"");return E=E.replace(n,"").replace(i,""),E&&(u+="&"+E),u.replace(i,"")}},EE.cp.cleanUrls=function(){e("a:not([href^=javascript])").attr("href",EE.cp.cleanUrl),e("form").attr("action",EE.cp.cleanUrl)},EE.insert_placeholders=function(){e('input[type="text"]').each(function(){if(this.placeholder){var t=e(this),o=this.placeholder,a=t.css("color");""==t.val()&&t.data("user_data","n"),t.focus(function(){t.css("color",a),t.val()===o&&(t.val(""),t.data("user_data","y"))}).blur(function(){""!==t.val()&&t.val!==o||(t.val(o).css("color","#888"),t.data("user_data","n"))}).trigger("blur")}})},EE.cp.broadcastEvents=function(){var t,o,a=1e3,n=18e5,i=27e5,s=3e6;e(document).ready(function(){t=e("#idle-modal"),o=e(".overlay"),t.find("form").on("interact",_.throttle(EE.cp.refreshSessionData,6e5)),t.find("form").on("submit",function(){return e.ajax({type:"POST",url:this.action,data:e(this).serialize(),dataType:"json",success:function(t){return"success"!=t.messageType?void alert(t.message):(c.login(),EE.cp.refreshSessionData(null,t.base),void e(window).trigger("broadcast.idleState","login"))},error:function(e){alert(e.message)}}),!1})});var r={hasFocus:!0,modalActive:!1,pingReceived:!1,lastActive:e.now(),lastRefresh:e.now(),setActiveTime:function(){!this.modalActive&&this.modalThresholdReached()||(this.refreshThresholdReached()&&this.doRefresh(),this.lastActive=e.now())},modalThresholdReached:function(){var t=e.now()-this.lastActive,o=this.hasFocus&&t>n||!this.hasFocus&&t>i;return this.modalActive===!1&&o===!0},refreshThresholdReached:function(){var t=e.now()-this.lastRefresh;return t>s},doRefresh:function(){this.lastRefresh=e.now(),EE.cp.refreshSessionData()},resolve:function(){return EE.hasRememberMe?void(this.refreshThresholdReached()&&this.doRefresh()):(this.modalThresholdReached()?(c.modal(),e(window).trigger("broadcast.idleState","modal"),e.get(EE.BASE+"&C=login&M=lock_cp")):this.hasFocus&&this.pingReceived===!1&&e(window).trigger("broadcast.idleState","active"),void(this.pingReceived=!1))}},c={active:function(){r.setActiveTime()},focus:function(){r.setActiveTime(),r.hasFocus=!0},blur:function(){r.setActiveTime(),r.hasFocus=!1},interact:function(){r.hasFocus&&r.setActiveTime()},modal:function(){r.modalActive||(t.trigger("modal:open"),t.on("modal:close",function(e){r.modalActive&&(e.preventDefault(),c.logout())}),r.modalActive=!0),r.setActiveTime()},login:function(){r.modalActive=!1,t.trigger("modal:close"),t.find(":password").val(""),r.setActiveTime()},logout:function(){window.location=EE.BASE+"&C=login&M=logout"}},l={_t:null,init:function(){e(window).trigger("broadcast.setBasePath",EE.BASE),e(window).trigger("broadcast.setCsrfToken",EE.CSRF_TOKEN),e(window).trigger("broadcast.setRememberMe",EE.hasRememberMe),e(window).trigger("broadcast.idleState","login"),this._bindEvents(),this.track()},_bindEvents:function(){var t=e.proxy(this,"track");e(window).on("broadcast.idleState",function(e,o){switch(o){case"active":r.pingReceived=!0,t(o);break;case"modal":case"login":case"logout":c[o]()}}),e(window).bind("blur",_.partial(t,"blur")),e(window).bind("focus",_.partial(t,"focus"));var o="DOMMouseScroll keydown mousedown mousemove mousewheel touchmove touchstart";e(document).on(o.split(" ").join(".idleState "),_.throttle(_.partial(t,"interact"),500)),e(".logOutButton").click(function(){e(window).trigger("broadcast.idleState","modal")})},track:function(t){clearTimeout(this._t),this._t=setTimeout(e.proxy(this,"track"),a),t&&c[t](),r.resolve()}};return l.init(),c}()}(jQuery);