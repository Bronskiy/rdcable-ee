/*
 * THIS IS NOT THE DEFAULT AUTOCOMPLETE
 * this file has been changed to better work with ie7 and to respect arrow keys and mousecilcks
 * this file is not interchangable with jquery.ui.autocomplete or the last revised autocomplete 1.1 mentioned below
 * THIS HAS ALSO BEEN MODIFIED TO BE PREFIXED WITH 'tag_' and 'Tag_ in all public aspects
 * this has been recompressed with yui compliler because i dont like packer -gf
 *//*
 * jQuery Tag_Autocomplete plugin 1.1
 *
 * Copyright (c) 2009 JÃ¶rn Zaefferer
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Revision: $Id: jquery.autocomplete.js 15 2009-08-22 10:30:27Z joern.zaefferer $
 */(function(e){var t={randomHash:"f1249759b77e529a6c49b9321dd58128"};e.fn.extend({tag_autocomplete:function(t,n){var r=typeof t=="string";n=e.extend({},e.Tag_Autocompleter.defaults,{url:r?t:null,data:r?null:t,delay:r?e.Tag_Autocompleter.defaults.delay:10,max:n&&!n.scroll?10:150},n);n.highlight=n.highlight||function(e){return e};n.formatMatch=n.formatMatch||n.formatItem;return this.each(function(){new e.Tag_Autocompleter(this,n)})},tag_result:function(e){return this.bind("tag_result",e)},tag_search:function(e){return this.trigger("tag_search",[e])},tag_flushCache:function(){return this.trigger("tag_flushCache")},tag_setOptions:function(e){return this.trigger("tag_setOptions",[e])},tag_unautocomplete:function(){return this.trigger("tag_unautocomplete")}});e.Tag_Autocompleter=function(n,r){function m(){var t=p.selected();if(!t)return!1;var n=t.result;u=n;if(r.multiple){var i=y(e.trim(s.val()));if(i.length>1){var o=r.multipleSeparator.length,a=h,f=i.length-1,l=0;e.each(i,function(e,t){l+=t.length;if(a<=l){f=e;return!1}l+=o});i[f]=n;n=i.join(r.multipleSeparator)}n+=r.multipleSeparator}s.val(n);S();s.trigger("tag_result",[t.data,t.value]);return!0}function g(t,o){h=e(n).selection().start;if(l==i.DEL){p.hide();return}var a=s.val();if(!o&&a==u)return;u=a;a=b(a);if(a.length>=r.minChars){s.addClass(r.loadingClass);r.matchCase||(a=a.toLowerCase());T(a,x,S)}else{C();p.hide()}}function y(t){return t?r.multiple?e.map(t.split(r.multipleSeparator),function(n){return e.trim(t).length?e.trim(n):null}):[e.trim(t)]:[""]}function b(t){if(!r.multiple)return t;var i=y(t);if(i.length==1)return i[0];var s=e(n).selection().start;s==t.length?i=y(t):i=y(t.replace(t.substring(s),""));return i[i.length-1]}function w(t,o){if(r.autoFill&&b(s.val()).toLowerCase()==t.toLowerCase()&&l!=i.BACKSPACE){s.val(s.val()+o.substring(b(u).length));e(n).selection(u.length,u.length+o.length)}}function E(){clearTimeout(o);o=setTimeout(S,200)}function S(){var e=p.visible();p.hide();clearTimeout(o);C();r.mustMatch&&s.tag_search(function(e){if(!e)if(r.multiple){var t=y(s.val()).slice(0,-1);s.val(t.join(r.multipleSeparator)+(t.length?r.multipleSeparator:""))}else{s.val("");s.trigger("tag_result",null)}})}function x(e,t){if(t&&t.length&&f){C();p.display(t,e);w(e,t[0].value);p.show()}else S()}function T(t,i,s){r.matchCase||(t=t.toLowerCase());var o=a.load(t);if(o&&o.length)i(t,o);else if(typeof r.url=="string"&&r.url.length>0){var u={timestamp:+(new Date)};e.each(r.extraParams,function(e,t){u[e]=typeof t=="function"?t():t});e.ajax({type:"POST",mode:"abort",port:"autocomplete"+n.name,dataType:r.dataType,url:r.url,data:e.extend({q:b(t),limit:r.max},u),success:function(e){var n=r.parse&&r.parse(e)||N(e);a.add(t,n);i(t,n)}})}else{p.emptyList();s(t)}}function N(t){var n=[],i=t.split("\n");for(var s=0;s<i.length;s++){var o=e.trim(i[s]);if(o){o=o.split("|");n[n.length]={data:o,value:o[0],result:r.formatResult&&r.formatResult(o,o[0])||o[0]}}}return n}function C(){s.removeClass(r.loadingClass)}var i={LEFT:37,UP:38,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SHIFT:16,CONTROL:17,ALT:18};t.multipleSeparator=r.multipleSeparator;var s=e(n).attr("autocomplete","off").addClass(r.inputClass),o,u="",a=e.Tag_Autocompleter.Cache(r),f=0,l,c={mouseDownOnSelect:!1},h=0,p=e.Tag_Autocompleter.Select(r,n,m,c),d,v="keydown";s.bind(v+".autocomplete",function(t){f=1;l=t.keyCode;switch(t.keyCode){case i.UP:if(p.visible()){t.preventDefault();p.prev()}break;case i.DOWN:if(p.visible()){t.preventDefault();p.next()}break;case i.PAGEUP:t.preventDefault();p.visible()?p.pageUp():g(0,!0);break;case i.PAGEDOWN:t.preventDefault();p.visible()?p.pageDown():g(0,!0);break;case i.LEFT:case i.RIGHT:case i.BACKSPACE:case i.SHIFT:case i.CONTROL:case i.ALT:break;case r.multiple&&e.trim(r.multipleSeparator)==","&&i.COMMA:case i.TAB:case i.RETURN:if(m()){t.preventDefault();d=!0;return!1}break;case i.ESC:p.hide();break;default:clearTimeout(o);o=setTimeout(g,r.delay)}}).focus(function(){f++}).blur(function(){f=0;c.mouseDownOnSelect||E()}).click(function(){f++>1&&!p.visible()}).bind("tag_search",function(){function n(e,n){var r;if(n&&n.length)for(var i=0;i<n.length;i++)if(n[i].result.toLowerCase()==e.toLowerCase()){r=n[i];break}typeof t=="function"?t(r):s.trigger("tag_result",r&&[r.data,r.value])}var t=arguments.length>1?arguments[1]:null;e.each(y(s.val()),function(e,t){T(t,n,n)})}).bind("tag_flushCache",function(){a.flush()}).bind("tag_setOptions",function(){e.extend(r,arguments[1]);"data"in arguments[1]&&a.populate()}).bind("tag_unautocomplete",function(){p.unbind();s.unbind();e(n.form).unbind(".autocomplete")})};e.Tag_Autocompleter.defaults={inputClass:"tag_ac_input",resultsClass:"tag_ac_results",loadingClass:"tag_ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};e.Tag_Autocompleter.Cache=function(t){function i(e,n){t.matchCase||(e=e.toLowerCase());var r=e.indexOf(n);t.matchContains=="word"&&(r=e.toLowerCase().search("\\b"+n.toLowerCase()));return r==-1?!1:r===0||t.matchContains}function s(e,i){r>t.cacheLength&&u();n[e]||r++;n[e]=i}function o(){if(!t.data)return!1;var n={},r=0;t.url||(t.cacheLength=1);n[""]=[];for(var i=0,o=t.data.length;i<o;i++){var u=t.data[i];u=typeof u=="string"?[u]:u;var a=t.formatMatch(u,i+1,t.data.length);if(a===!1)continue;var f=a.charAt(0).toLowerCase();n[f]||(n[f]=[]);var l={value:a,data:u,result:t.formatResult&&t.formatResult(u)||a};n[f].push(l);r++<t.max&&n[""].push(l)}e.each(n,function(e,n){t.cacheLength++;s(e,n)})}function u(){n={};r=0}var n={},r=0;setTimeout(o,25);return{flush:u,add:s,populate:o,load:function(s){if(!t.cacheLength||!r)return null;if(!t.url&&t.matchContains){var o=[];for(var u in n)if(u.length>0){var a=n[u];e.each(a,function(e,t){i(t.value,s)&&o.push(t)})}return o}if(n[s])return n[s];if(t.matchSubset)for(var f=s.length-1;f>=t.minChars;f--){var a=n[s.substr(0,f)];if(a){var o=[];e.each(a,function(e,t){i(t.value,s)&&(o[o.length]=t)});return o}}return null}}};e.Tag_Autocompleter.Select=function(t,n,r,i){function p(){if(!l)return;c=e("<div/>").hide().addClass(t.resultsClass).css("position","absolute").appendTo(document.body);h=e("<ul/>").appendTo(c).mouseover(function(t){if(d(t).nodeName&&d(t).nodeName.toUpperCase()=="LI"){u=e("li",h).removeClass(s.ACTIVE).index(d(t));e(d(t)).addClass(s.ACTIVE)}}).click(function(t){e(d(t)).addClass(s.ACTIVE);r();n.focus();return!1}).mousedown(function(){i.mouseDownOnSelect=!0}).mouseup(function(){i.mouseDownOnSelect=!1});t.width>0&&c.css("width",t.width);l=!1}function d(e){var t=e.target;while(t&&t.tagName!="LI")t=t.parentNode;return t?t:[]}function v(e){o.slice(u,u+1).removeClass(s.ACTIVE);m(e);var n=o.slice(u,u+1).addClass(s.ACTIVE);if(t.scroll){var r=0;o.slice(0,u).each(function(){r+=this.offsetHeight});r+n[0].offsetHeight-h.scrollTop()>h[0].clientHeight?h.scrollTop(r+n[0].offsetHeight-h.innerHeight()):r<h.scrollTop()&&h.scrollTop(r)}}function m(e){u+=e;u<0?u=o.size()-1:u>=o.size()&&(u=0)}function g(e){return t.max&&t.max<e?t.max:e}function y(){h.empty();var n=g(a.length);for(var r=0;r<n;r++){if(!a[r])continue;var i=t.formatItem(a[r].data,r+1,n,a[r].value,f);if(i===!1)continue;var l=e("<li/>").html(t.highlight(i,f)).addClass(r%2==0?"tag_ac_even":"tag_ac_odd").appendTo(h)[0];e.data(l,"tag_ac_data",a[r])}o=h.find("li");if(t.selectFirst){o.slice(0,1).addClass(s.ACTIVE);u=0}e.fn.bgiframe&&h.bgiframe()}var s={ACTIVE:"tag_ac_over"},o,u=-1,a,f="",l=!0,c,h;return{display:function(e,t){p();a=e;f=t;y()},next:function(){v(1)},prev:function(){v(-1)},pageUp:function(){u!=0&&u-8<0?v(-u):v(-8)},pageDown:function(){u!=o.size()-1&&u+8>o.size()?v(o.size()-1-u):v(8)},hide:function(){c&&c.hide();o&&o.removeClass(s.ACTIVE);u=-1},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(o.filter("."+s.ACTIVE)[0]||t.selectFirst&&o[0])},show:function(){var r=e(n).offset();c.css({width:typeof t.width=="string"||t.width>0?t.width:e(n).width(),top:r.top+n.offsetHeight,left:r.left}).show();if(t.scroll){h.scrollTop(0);h.css({maxHeight:t.scrollHeight,overflow:"auto"})}},selected:function(){var t=o&&o.filter("."+s.ACTIVE).removeClass(s.ACTIVE);return t&&t.length&&e.data(t[0],"tag_ac_data")},emptyList:function(){h&&h.empty()},unbind:function(){c&&c.remove()}}};e.fn.selection=function(e,n){if(e!==undefined)return this.each(function(){if(this.createTextRange){var t=this.createTextRange();if(n===undefined||e==n){t.move("character",e);t.select()}else{t.collapse(!0);t.moveStart("character",e);t.moveEnd("character",n);t.select()}}else if(this.setSelectionRange)this.setSelectionRange(e,n);else if(this.selectionStart){this.selectionStart=e;this.selectionEnd=n}});var r=this[0];if(r.createTextRange){var i=document.selection.createRange(),s=r.value,o="<->",u=i.text.length;i.text=o;var a=r.value.indexOf(o);r.value=s;var f=s.substr(a);f=f.substring(0,f.indexOf(t.multiplesSeperator));u=f.length;this.selection(a,a+u);return{start:a,end:a+u}}if(r.selectionStart!==undefined)return{start:r.selectionStart,end:r.selectionEnd}}})(jQuery);